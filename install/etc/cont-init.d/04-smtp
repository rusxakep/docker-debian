#!/usr/bin/with-contenv bash

for s in /assets/functions/*; do source $s; done
PROCESS_NAME="smtp"
s6-svc -d /var/run/s6/services/`basename $0`

### Debug Mode - Enable MailHog
if [ "$DEBUG_SMTP" = "TRUE" ] || [ "$DEBUG_SMTP" = "true" ];  then
    ENABLE_SMTP=FALSE

          case "SMTP_HOST" in
              "postfix-relay")
              SMTP_HOST=localhost
              ;;
              "mailcatcher")
              :
              ;;
          esac


    echo "### Automatically Generated on Container Start. See Documentation on how to set!" >/etc/msmtp
    echo "account default " >>/etc/msmtp
    echo "host ${SMTP_HOST}" >>/etc/msmtp
    echo "port 1025" >>/etc/msmtp
    echo "domain ${SMTP_DOMAIN}" >>/etc/msmtp
    echo "maildomain ${SMTP_MAILDOMAIN}" >>/etc/msmtp
    echo "tls ${SMTP_TLS}" >>/etc/msmtp
    echo "tls_starttls ${SMTP_STARTTLS}" >>/etc/msmtp
    echo "tls_certcheck ${SMTP_TLSCERTCHECK}" >>/etc/msmtp
    if [ -n "$SMTP_TLSTRUSTFILE" ]; then echo 'tls_trust_file '$SMTP_TLSTRUSTFILE >> /etc/msmtprc; fi 

### Gmail Specific SMTP Config
    if [ "$ENABLE_SMTP_GMAIL" = "TRUE" ] || [ "$ENABLE_SMTP_GMAIL" = "true" ]; then
         echo "auto_from on" >> /etc/msmtp
    fi
    
    rm -f /usr/sbin/sendmail
    ln -s /usr/bin/msmtp /usr/sbin/sendmail

    s6-svc -u /var/run/s6/services/`basename $0`
    print_debug "SMTP Mailcatcher Enabled at Port 1025, Map an exposed port and visit Visit http://127.0.0.1:8025 for Web Interface"
fi

### Enable or Disable SMTP
if [ "$ENABLE_SMTP" = "TRUE" ] || [ "$ENABLE_SMTP" = "true" ];  then

  rm -f /usr/sbin/sendmail
  ln -s /usr/bin/msmtp /usr/sbin/sendmail

  echo "### Automatically Generated on Container Start. See Documentation on how to set!" >/etc/msmtp
  echo "account default " >>/etc/msmtp
  echo "host ${SMTP_HOST}" >>/etc/msmtp
    echo "port ${SMTP_PORT}" >>/etc/msmtp
    echo "domain ${SMTP_DOMAIN}" >>/etc/msmtp
  echo "maildomain ${SMTP_MAILDOMAIN}" >>/etc/msmtp
    if [ -n "$SMTP_AUTHENTICATION" ]; then echo "auth ${SMTP_AUTHENTICATION}" >>/etc/msmtp; fi
    if [ -n "$SMTP_USER" ]; then echo "user ${SMTP_USER}" >>/etc/msmtp; fi
  if [ -n "$SMTP_PASS" ]; then echo "password ${SMTP_PASS}" >>/etc/msmtp; fi
    echo "tls ${SMTP_TLS}" >>/etc/msmtp
    echo "tls_starttls ${SMTP_STARTTLS}" >>/etc/msmtp
    echo "tls_certcheck ${SMTP_TLSCERTCHECK}" >>/etc/msmtp
    
  export ENABLE_SMTP=TRUE
  print_notice "Sendmail replaced and enabled to route mail to: '${SMTP_HOST}'"
else
  print_notice "Disabling SMTP Features"
fi

liftoff
