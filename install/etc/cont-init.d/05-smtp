#!/usr/bin/with-contenv bash

for s in /assets/functions/*; do source $s; done
PROCESS_NAME="smtp"

output_off
### Debug Mode - Enable MailHog
if [ "$DEBUG_SMTP" = "TRUE" ] || [ "$DEBUG_SMTP" = "true" ];  then
    print_notice "SMTP Debugging Mode activated"
    SMTP_HOST="localhost"
    SMTP_PORT=1025
else
    service_stop `basename $0`
fi

rm -f /usr/sbin/sendmail
ln -s /usr/bin/msmtp /usr/sbin/sendmail

if [ "$ENABLE_SMTP" = "TRUE" ] || [ "$ENABLE_SMTP" = "true" ];  then
  rm -f /usr/sbin/sendmail
  ln -s /usr/bin/msmtp /usr/sbin/sendmail

  echo "### Automatically Generated on Container Start. See Documentation on how to set!" > /etc/msmtprc
  echo "account default " >> /etc/msmtprc
  echo "host ${SMTP_HOST}" >> /etc/msmtprc
  echo "port ${SMTP_PORT}" >> /etc/msmtprc
  echo "domain ${SMTP_DOMAIN}" >> /etc/msmtprc
  echo "maildomain ${SMTP_MAILDOMAIN}" >> /etc/msmtprc
  if [ -n "$SMTP_AUTHENTICATION" ]; then echo "auth ${SMTP_AUTHENTICATION}" >> /etc/msmtprc; fi
  if [ -n "$SMTP_USER" ]; then echo "user ${SMTP_USER}" >> /etc/msmtprc; fi
  if [ -n "$SMTP_PASS" ]; then echo "password ${SMTP_PASS}" >> /etc/msmtprc; fi
  echo "tls ${SMTP_TLS}" >> /etc/msmtprc
  echo "tls_starttls ${SMTP_STARTTLS}" >> /etc/msmtprc
  echo "tls_certcheck ${SMTP_TLSCERTCHECK}" >> /etc/msmtprc

### Gmail Specific SMTP Config
    if [ "$ENABLE_SMTP_GMAIL" = "TRUE" ] || [ "$ENABLE_SMTP_GMAIL" = "true" ]; then
         echo "auto_from on" >> /etc/msmtprc
    fi

  print_notice "Sendmail replaced and enabled to route mail to: '${SMTP_HOST}'"
else
  print_notice "Disabling SMTP Features"
fi

output_on
liftoff
